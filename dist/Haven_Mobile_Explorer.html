<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Haven Explorer">
    <meta name="theme-color" content="#0a0e27">
    <meta name="description" content="Haven Galaxy Mobile Explorer - Add systems, generate maps, explore the galaxy">
    <title>Haven Galaxy - Mobile Explorer</title>

    <!-- iOS Home Screen Icon - Base64 encoded Haven logo -->
    <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAYAAAA9zQYyAAAACXBIWXMAAAsTAAALEwEAmpwYAAABSklEQVR4nO3BMQEAAADCoPVPbQwfoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOBuLFIAAa+w8i0AAAAASUVORK5CYII=">

    <style>
        /* ========== RESET & BASE ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --bg-primary: #0a0e27;
            --bg-secondary: #141b3d;
            --bg-card: #1a2342;
            --accent-cyan: #00d9ff;
            --accent-purple: #9d4edd;
            --accent-pink: #ff006e;
            --text-primary: #ffffff;
            --text-secondary: #8892b0;
            --success: #00ff88;
            --warning: #ffb703;
            --error: #ff006e;
            --border: rgba(0, 217, 255, 0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, #1a1a2e 50%, #0f0f1e 100%);
            color: var(--text-primary);
            overflow: hidden;
            touch-action: pan-x pan-y;
            -webkit-user-select: none;
            user-select: none;
            height: 100vh;
            width: 100vw;
        }

        /* Safe area for iPhone notch */
        body {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* ========== INSTALL PROMPT (iOS Helper) ========== */
        #install-prompt {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        #install-prompt.show {
            display: flex;
        }

        .install-content {
            background: var(--bg-secondary);
            border: 2px solid var(--accent-cyan);
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            text-align: center;
        }

        .install-content h2 {
            color: var(--accent-cyan);
            margin-bottom: 16px;
            font-size: 24px;
        }

        .install-content p {
            color: var(--text-secondary);
            margin-bottom: 12px;
            line-height: 1.6;
        }

        .install-step {
            background: var(--bg-card);
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            border-left: 3px solid var(--accent-cyan);
            text-align: left;
        }

        .install-step strong {
            color: var(--accent-cyan);
        }

        #close-install-btn {
            margin-top: 20px;
            padding: 12px 24px;
            background: var(--accent-cyan);
            color: var(--bg-primary);
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
        }

        /* ========== HEADER ========== */
        #app-header {
            position: fixed;
            top: env(safe-area-inset-top);
            left: 0;
            right: 0;
            height: 56px;
            background: rgba(10, 14, 39, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            z-index: 1000;
        }

        #app-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--accent-cyan);
            letter-spacing: 0.5px;
        }

        #system-count {
            font-size: 14px;
            color: var(--text-secondary);
            background: var(--bg-card);
            padding: 4px 12px;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        /* ========== BOTTOM TAB NAVIGATION ========== */
        #bottom-nav {
            position: fixed;
            bottom: env(safe-area-inset-bottom);
            left: 0;
            right: 0;
            height: 60px;
            background: rgba(10, 14, 39, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .tab-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px;
            color: var(--text-secondary);
            background: none;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 44px;
        }

        .tab-btn.active {
            color: var(--accent-cyan);
        }

        .tab-icon {
            font-size: 24px;
            margin-bottom: 2px;
        }

        .tab-label {
            font-size: 11px;
            font-weight: 500;
        }

        /* ========== MAIN CONTENT ========== */
        #app-content {
            position: fixed;
            top: calc(56px + env(safe-area-inset-top));
            left: 0;
            right: 0;
            bottom: calc(60px + env(safe-area-inset-bottom));
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        .tab-content {
            display: none;
            padding: 16px;
            min-height: 100%;
        }

        .tab-content.active {
            display: block;
        }

        /* ========== FORM STYLING ========== */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            color: var(--accent-cyan);
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 14px;
        }

        .form-label .required {
            color: var(--error);
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 16px;
            font-family: inherit;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 2px rgba(0, 217, 255, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
        }

        /* ========== BUTTONS ========== */
        .btn {
            padding: 12px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--accent-cyan);
            color: var(--bg-primary);
        }

        .btn-primary:active {
            background: #00b8d4;
            transform: scale(0.98);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--accent-cyan);
            border: 1px solid var(--accent-cyan);
        }

        .btn-danger {
            background: var(--error);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: var(--bg-primary);
        }

        .btn-block {
            width: 100%;
            margin-top: 8px;
        }

        /* ========== CARD STYLING ========== */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .card-title {
            color: var(--accent-cyan);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        /* ========== SYSTEM LIST ========== */
        .system-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .system-info {
            flex: 1;
        }

        .system-name {
            color: var(--accent-cyan);
            font-weight: 600;
            margin-bottom: 4px;
        }

        .system-coords {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .system-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            min-height: 44px;
            min-width: 44px;
        }

        .icon-btn:active {
            color: var(--accent-cyan);
        }

        /* ========== MAP VIEWER ========== */
        #map-container {
            width: 100%;
            height: calc(100vh - 116px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
            position: relative;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
        }

        #map-canvas {
            width: 100%;
            height: 100%;
            display: block;
            touch-action: none;
        }

        #map-controls {
            position: absolute;
            bottom: 16px;
            left: 16px;
            right: 16px;
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .map-btn {
            background: rgba(0, 217, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid var(--accent-cyan);
            color: var(--accent-cyan);
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            min-height: 44px;
        }

        #map-info {
            position: absolute;
            top: 16px;
            left: 16px;
            right: 16px;
            background: rgba(10, 20, 40, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid var(--accent-cyan);
            border-radius: 12px;
            padding: 12px;
            display: none;
            max-height: 200px;
            overflow-y: auto;
        }

        #map-info.show {
            display: block;
        }

        /* ========== LOGS ========== */
        .log-entry {
            background: var(--bg-card);
            border-left: 3px solid var(--accent-cyan);
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            font-size: 14px;
        }

        .log-time {
            color: var(--text-secondary);
            font-size: 12px;
            margin-bottom: 4px;
        }

        .log-message {
            color: var(--text-primary);
        }

        /* ========== PHOTO UPLOAD ========== */
        .photo-upload-area {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .photo-upload-area:active {
            border-color: var(--accent-cyan);
            background: rgba(0, 217, 255, 0.05);
        }

        .photo-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 12px;
        }

        #photo-input {
            display: none;
        }

        /* ========== LOADING ========== */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .spinner {
            border: 3px solid rgba(0, 217, 255, 0.1);
            border-top: 3px solid var(--accent-cyan);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ========== MODAL ========== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border: 2px solid var(--accent-cyan);
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .modal-title {
            color: var(--accent-cyan);
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
        }

        .planet-list-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
        }

        .planet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .planet-name {
            color: var(--accent-cyan);
            font-weight: 600;
        }

        .planet-info {
            color: var(--text-secondary);
            font-size: 13px;
            margin-bottom: 4px;
        }

        .moon-badge {
            display: inline-block;
            background: rgba(0, 217, 255, 0.2);
            border: 1px solid var(--accent-cyan);
            color: var(--accent-cyan);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin-right: 4px;
        }

        .btn-group {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
            min-height: 36px;
        }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 375px) {
            #app-title {
                font-size: 16px;
            }

            .tab-label {
                font-size: 10px;
            }

            .form-input,
            .form-textarea,
            .form-select {
                font-size: 16px; /* Prevents iOS zoom on focus */
            }
        }
    </style>
</head>
<body>
    <!-- iOS Install Prompt -->
    <div id="install-prompt">
        <div class="install-content">
            <h2>üì± Install Haven Explorer</h2>
            <p>For the best experience, add this app to your home screen!</p>

            <div class="install-step">
                <strong>Step 1:</strong> Tap the Share button <span style="font-size: 20px;">‚éô</span> at the bottom of Safari
            </div>
            <div class="install-step">
                <strong>Step 2:</strong> Scroll down and tap "Add to Home Screen"
            </div>
            <div class="install-step">
                <strong>Step 3:</strong> Tap "Add" in the top right
            </div>

            <p style="margin-top: 16px; font-size: 13px;">You can also use the app in Safari without installing.</p>

            <button id="close-install-btn">Got it, let's explore!</button>
        </div>
    </div>

    <!-- Planet Manager Modal -->
    <div id="planet-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Manage Planets & Moons</div>
                <button class="modal-close" onclick="App.closePlanetModal()">‚úï</button>
            </div>

            <div id="planets-list-container"></div>

            <button class="btn btn-primary btn-block" onclick="App.addPlanet()">
                üåç Add Planet
            </button>
        </div>
    </div>

    <!-- Planet/Moon Entry Modal -->
    <div id="planet-entry-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="planet-entry-title">Add Planet</div>
                <button class="modal-close" onclick="App.closePlanetEntryModal()">‚úï</button>
            </div>

            <form id="planet-entry-form">
                <input type="hidden" id="planet-edit-index" value="">
                <input type="hidden" id="is-moon" value="false">
                <input type="hidden" id="parent-planet-index" value="">

                <div class="form-group">
                    <label class="form-label">Name <span class="required">*</span></label>
                    <input type="text" id="planet-entry-name" class="form-input" placeholder="e.g., Paradise Prime" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Type</label>
                    <select id="planet-entry-type" class="form-select">
                        <option value="">Select Type</option>
                        <option value="Lush">Lush</option>
                        <option value="Desert">Desert</option>
                        <option value="Frozen">Frozen</option>
                        <option value="Toxic">Toxic</option>
                        <option value="Radioactive">Radioactive</option>
                        <option value="Scorched">Scorched</option>
                        <option value="Barren">Barren</option>
                        <option value="Exotic">Exotic</option>
                        <option value="Dead">Dead</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Fauna</label>
                    <select id="planet-entry-fauna" class="form-select">
                        <option value="">Select Level</option>
                        <option value="None">None</option>
                        <option value="Low">Low</option>
                        <option value="Medium">Medium</option>
                        <option value="High">High</option>
                        <option value="Full">Full</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Flora</label>
                    <select id="planet-entry-flora" class="form-select">
                        <option value="">Select Level</option>
                        <option value="None">None</option>
                        <option value="Low">Low</option>
                        <option value="Medium">Medium</option>
                        <option value="High">High</option>
                        <option value="Full">Full</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Sentinels</label>
                    <select id="planet-entry-sentinels" class="form-select">
                        <option value="">Select Level</option>
                        <option value="None">None</option>
                        <option value="Low">Low</option>
                        <option value="Medium">Medium</option>
                        <option value="High">High</option>
                        <option value="Aggressive">Aggressive</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Resources</label>
                    <textarea id="planet-entry-resources" class="form-textarea" placeholder="Carbon, Ferrite, Gold..."></textarea>
                </div>

                <button type="submit" class="btn btn-primary btn-block">
                    üíæ Save
                </button>
                <button type="button" class="btn btn-secondary btn-block" onclick="App.closePlanetEntryModal()">
                    Cancel
                </button>
            </form>
        </div>
    </div>

    <!-- App Header -->
    <div id="app-header">
        <div id="app-title">üåå Haven Explorer</div>
        <div id="system-count">0 Systems</div>
    </div>

    <!-- Main Content Area -->
    <div id="app-content">
        <!-- WIZARD TAB -->
        <div id="wizard-tab" class="tab-content active">
            <div class="card">
                <h2 class="card-title">System Entry Wizard</h2>

                <form id="system-form">
                    <input type="hidden" id="system-id" value="">

                    <div class="form-group">
                        <label class="form-label">System Name <span class="required">*</span></label>
                        <input type="text" id="system-name" class="form-input" placeholder="e.g., ALPHA-7432" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Region <span class="required">*</span></label>
                        <select id="system-region" class="form-select" required>
                            <option value="">Select Region</option>
                            <option value="Core">Core</option>
                            <option value="Outer Rim">Outer Rim</option>
                            <option value="Frontier">Frontier</option>
                            <option value="Star">Star</option>
                            <option value="Adam">Adam</option>
                            <option value="Unknown">Unknown</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Coordinates <span class="required">*</span></label>
                        <div class="form-row">
                            <input type="number" step="0.1" id="system-x" class="form-input" placeholder="X" required>
                            <input type="number" step="0.1" id="system-y" class="form-input" placeholder="Y" required>
                            <input type="number" step="0.1" id="system-z" class="form-input" placeholder="Z" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Planets & Moons</label>
                        <div id="planets-summary" style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 8px; color: var(--text-secondary);">
                            No planets added yet
                        </div>
                        <button type="button" class="btn btn-secondary btn-block" onclick="App.openPlanetModal()">
                            üåç Manage Planets & Moons
                        </button>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea id="system-notes" class="form-textarea" placeholder="Additional information..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Photo</label>
                        <div class="photo-upload-area" onclick="document.getElementById('photo-input').click()">
                            <div id="photo-placeholder">
                                üì∑ Tap to add photo<br>
                                <small style="color: var(--text-secondary);">From camera or gallery</small>
                            </div>
                            <img id="photo-preview" class="photo-preview" style="display: none;">
                        </div>
                        <input type="file" id="photo-input" accept="image/*" capture="environment">
                    </div>

                    <button type="submit" class="btn btn-primary btn-block">
                        üíæ Save System
                    </button>
                    <button type="button" id="clear-form-btn" class="btn btn-secondary btn-block">
                        üóëÔ∏è Clear Form
                    </button>
                </form>
            </div>

            <div class="card">
                <h2 class="card-title">Saved Systems</h2>
                <div id="systems-list"></div>
            </div>
        </div>

        <!-- MAP TAB -->
        <div id="map-tab" class="tab-content">
            <div id="map-container">
                <div id="map-canvas"></div>
                <div id="map-info"></div>
                <div id="map-controls">
                    <button class="map-btn" onclick="App.resetMapView()">üîÑ Reset View</button>
                    <button class="map-btn" onclick="App.toggleMapInfo()">‚ÑπÔ∏è Info</button>
                </div>
            </div>
            <button class="btn btn-primary btn-block" onclick="App.generateMap()" style="margin-top: 16px;">
                üó∫Ô∏è Regenerate Map
            </button>
        </div>

        <!-- LOGS TAB -->
        <div id="logs-tab" class="tab-content">
            <div class="card">
                <h2 class="card-title">Activity Logs</h2>
                <div id="logs-list"></div>
            </div>
            <button class="btn btn-danger btn-block" onclick="App.clearLogs()">
                üóëÔ∏è Clear All Logs
            </button>
        </div>

        <!-- EXPORT TAB -->
        <div id="export-tab" class="tab-content">
            <div class="card">
                <h2 class="card-title">Data Management</h2>

                <div style="margin-bottom: 16px; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                    <div style="color: var(--text-secondary); font-size: 14px;">Total Systems</div>
                    <div id="export-count" style="color: var(--accent-cyan); font-size: 32px; font-weight: bold;">0</div>
                </div>

                <button class="btn btn-success btn-block" onclick="App.exportData()">
                    üì§ Export JSON File
                </button>

                <button class="btn btn-secondary btn-block" onclick="document.getElementById('import-input').click()">
                    üì• Import JSON File
                </button>
                <input type="file" id="import-input" accept=".json" style="display: none;">

                <button class="btn btn-danger btn-block" onclick="App.clearAllData()">
                    ‚ö†Ô∏è Clear All Data
                </button>

                <div style="margin-top: 24px; padding: 16px; background: var(--bg-secondary); border-left: 3px solid var(--accent-cyan); border-radius: 8px;">
                    <h3 style="color: var(--accent-cyan); margin-bottom: 8px;">üí° Tips</h3>
                    <ul style="color: var(--text-secondary); font-size: 14px; line-height: 1.8; list-style: none; padding: 0;">
                        <li>üì§ Export your data regularly as backup</li>
                        <li>üìß Send exported JSON to mission control</li>
                        <li>üîÑ Don't exceed 200 systems per file</li>
                        <li>üì∑ Photos are embedded in the JSON</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div id="bottom-nav">
        <button class="tab-btn active" onclick="App.switchTab('wizard')">
            <div class="tab-icon">üõ∞Ô∏è</div>
            <div class="tab-label">Wizard</div>
        </button>
        <button class="tab-btn" onclick="App.switchTab('map')">
            <div class="tab-icon">üó∫Ô∏è</div>
            <div class="tab-label">Map</div>
        </button>
        <button class="tab-btn" onclick="App.switchTab('logs')">
            <div class="tab-icon">üìã</div>
            <div class="tab-label">Logs</div>
        </button>
        <button class="tab-btn" onclick="App.switchTab('export')">
            <div class="tab-icon">üì§</div>
            <div class="tab-label">Export</div>
        </button>
    </div>

    <!-- Three.js Library (CDN - will cache for offline) -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>

    <!-- Main Application JavaScript -->
    <script>
        const App = {
            systems: [],
            logs: [],
            scene: null,
            camera: null,
            renderer: null,
            controls: null,
            currentEditId: null,
            currentPlanets: [],
            mapInitialized: false,

            // Initialize app
            init() {
                this.loadFromStorage();
                this.setupEventListeners();
                this.renderSystemsList();
                this.renderLogs();
                this.updateSystemCount();
                this.checkInstallPrompt();

                console.log('Haven Mobile Explorer initialized');
                this.addLog('App started successfully');
            },

            // Check if should show install prompt (iOS Safari)
            checkInstallPrompt() {
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                const isInStandaloneMode = ('standalone' in window.navigator) && (window.navigator.standalone);
                const hasSeenPrompt = localStorage.getItem('installPromptSeen');

                if (isIOS && !isInStandaloneMode && !hasSeenPrompt) {
                    setTimeout(() => {
                        document.getElementById('install-prompt').classList.add('show');
                    }, 1000);
                }
            },

            // Setup event listeners
            setupEventListeners() {
                // Form submit
                document.getElementById('system-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveSystem();
                });

                // Planet entry form submit
                document.getElementById('planet-entry-form').addEventListener('submit', (e) => {
                    this.savePlanetEntry(e);
                });

                // Clear form
                document.getElementById('clear-form-btn').addEventListener('click', () => {
                    this.clearForm();
                });

                // Photo input
                document.getElementById('photo-input').addEventListener('change', (e) => {
                    this.handlePhotoUpload(e);
                });

                // Import JSON
                document.getElementById('import-input').addEventListener('change', (e) => {
                    this.importData(e);
                });

                // Close install prompt
                document.getElementById('close-install-btn').addEventListener('click', () => {
                    document.getElementById('install-prompt').classList.remove('show');
                    localStorage.setItem('installPromptSeen', 'true');
                });
            },

            // Switch between tabs
            switchTab(tabName) {
                // Update tab buttons
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                event.currentTarget.classList.add('active');

                // Update tab content
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById(`${tabName}-tab`).classList.add('active');

                // Initialize map if switching to map tab
                if (tabName === 'map' && !this.mapInitialized) {
                    setTimeout(() => {
                        this.initMap();
                        this.generateMap();
                    }, 100);
                }

                // Update export count
                if (tabName === 'export') {
                    document.getElementById('export-count').textContent = this.systems.length;
                }

                this.addLog(`Switched to ${tabName} tab`);
            },

            // Save or update system
            saveSystem() {
                const systemData = {
                    id: this.currentEditId || Date.now().toString(),
                    name: document.getElementById('system-name').value.trim(),
                    region: document.getElementById('system-region').value,
                    x: parseFloat(document.getElementById('system-x').value),
                    y: parseFloat(document.getElementById('system-y').value),
                    z: parseFloat(document.getElementById('system-z').value),
                    planets: this.currentPlanets, // Now an array of objects with moons
                    fauna: document.getElementById('system-fauna').value,
                    flora: document.getElementById('system-flora').value,
                    sentinel: document.getElementById('system-sentinel').value,
                    materials: document.getElementById('system-materials').value.trim(),
                    base_location: document.getElementById('system-base').value.trim(),
                    attributes: document.getElementById('system-notes').value.trim(),
                    photo: document.getElementById('photo-preview').src.startsWith('data:')
                        ? document.getElementById('photo-preview').src
                        : null,
                    created_at: new Date().toISOString(),
                    modified_at: new Date().toISOString()
                };

                // Validation
                if (!systemData.name || !systemData.region) {
                    alert('Please fill in System Name and Region');
                    return;
                }

                if (isNaN(systemData.x) || isNaN(systemData.y) || isNaN(systemData.z)) {
                    alert('Please enter valid coordinates (numbers only)');
                    return;
                }

                // Check for duplicates (unless editing)
                const existingIndex = this.systems.findIndex(s => s.id === systemData.id);

                if (existingIndex >= 0) {
                    // Update existing
                    systemData.created_at = this.systems[existingIndex].created_at;
                    this.systems[existingIndex] = systemData;
                    this.addLog(`Updated system: ${systemData.name}`);
                } else {
                    // Add new
                    this.systems.push(systemData);
                    this.addLog(`Added new system: ${systemData.name}`);
                }

                this.saveToStorage();
                this.renderSystemsList();
                this.updateSystemCount();
                this.clearForm();

                // Show success feedback
                const saveBtn = document.querySelector('#system-form button[type="submit"]');
                const originalText = saveBtn.innerHTML;
                saveBtn.innerHTML = '‚úÖ Saved!';
                saveBtn.style.background = 'var(--success)';
                setTimeout(() => {
                    saveBtn.innerHTML = originalText;
                    saveBtn.style.background = '';
                }, 2000);
            },

            // Edit system
            editSystem(id) {
                const system = this.systems.find(s => s.id === id);
                if (!system) return;

                this.currentEditId = id;

                // Populate form
                document.getElementById('system-name').value = system.name;
                document.getElementById('system-region').value = system.region;
                document.getElementById('system-x').value = system.x;
                document.getElementById('system-y').value = system.y;
                document.getElementById('system-z').value = system.z;
                
                // Load planets - handle both old string format and new object format
                if (Array.isArray(system.planets)) {
                    if (system.planets.length > 0 && typeof system.planets[0] === 'string') {
                        // Old format: convert strings to planet objects
                        this.currentPlanets = system.planets.map(name => ({
                            name: name,
                            type: '',
                            fauna: '',
                            flora: '',
                            sentinels: '',
                            resources: '',
                            moons: []
                        }));
                    } else {
                        // New format: deep copy planet objects
                        this.currentPlanets = JSON.parse(JSON.stringify(system.planets));
                    }
                } else {
                    this.currentPlanets = [];
                }
                this.updatePlanetsSummary();
                
                document.getElementById('system-fauna').value = system.fauna || '';
                document.getElementById('system-flora').value = system.flora || '';
                document.getElementById('system-sentinel').value = system.sentinel || '';
                document.getElementById('system-materials').value = system.materials || '';
                document.getElementById('system-base').value = system.base_location || '';
                document.getElementById('system-notes').value = system.attributes || '';

                // Handle photo
                if (system.photo) {
                    document.getElementById('photo-preview').src = system.photo;
                    document.getElementById('photo-preview').style.display = 'block';
                    document.getElementById('photo-placeholder').style.display = 'none';
                }

                // Scroll to top
                document.getElementById('app-content').scrollTop = 0;

                this.addLog(`Editing system: ${system.name}`);
            },

            // Delete system
            deleteSystem(id) {
                const system = this.systems.find(s => s.id === id);
                if (!system) return;

                if (confirm(`Delete system "${system.name}"?`)) {
                    this.systems = this.systems.filter(s => s.id !== id);
                    this.saveToStorage();
                    this.renderSystemsList();
                    this.updateSystemCount();
                    this.addLog(`Deleted system: ${system.name}`);
                }
            },

            // Clear form
            clearForm() {
                this.currentEditId = null;
                this.currentPlanets = [];
                this.updatePlanetsSummary();
                document.getElementById('system-form').reset();
                document.getElementById('photo-preview').style.display = 'none';
                document.getElementById('photo-preview').src = '';
                document.getElementById('photo-placeholder').style.display = 'block';
            },

            // Handle photo upload
            handlePhotoUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                // Check file size (max 2MB to keep JSON manageable)
                if (file.size > 2 * 1024 * 1024) {
                    alert('Photo is too large. Please choose a photo under 2MB.');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('photo-preview').src = e.target.result;
                    document.getElementById('photo-preview').style.display = 'block';
                    document.getElementById('photo-placeholder').style.display = 'none';
                    this.addLog('Photo added to system');
                };
                reader.readAsDataURL(file);
            },

            // Render systems list
            renderSystemsList() {
                const container = document.getElementById('systems-list');

                if (this.systems.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">No systems added yet.<br>Use the form above to add your first system!</div>';
                    return;
                }

                container.innerHTML = this.systems.map(system => {
                    // Calculate planet and moon counts
                    let planetCount = 0;
                    let moonCount = 0;
                    
                    if (Array.isArray(system.planets)) {
                        planetCount = system.planets.length;
                        if (planetCount > 0 && typeof system.planets[0] === 'object') {
                            // New format with moon support
                            moonCount = system.planets.reduce((total, planet) => {
                                return total + (planet.moons ? planet.moons.length : 0);
                            }, 0);
                        }
                    }

                    const planetInfo = planetCount > 0 
                        ? `<div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">üåç ${planetCount} planet${planetCount !== 1 ? 's' : ''}${moonCount > 0 ? `, üåô ${moonCount} moon${moonCount !== 1 ? 's' : ''}` : ''}</div>`
                        : '';

                    return `
                        <div class="system-item">
                            <div class="system-info">
                                <div class="system-name">${system.name}</div>
                                <div class="system-coords">${system.region} ‚Ä¢ (${system.x}, ${system.y}, ${system.z})</div>
                                ${planetInfo}
                            </div>
                            <div class="system-actions">
                                <button class="icon-btn" onclick="App.editSystem('${system.id}')" title="Edit">‚úèÔ∏è</button>
                                <button class="icon-btn" onclick="App.deleteSystem('${system.id}')" title="Delete">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            // Update system count
            updateSystemCount() {
                document.getElementById('system-count').textContent = `${this.systems.length} System${this.systems.length !== 1 ? 's' : ''}`;

                // Warning if approaching limit
                if (this.systems.length >= 180) {
                    this.addLog(`‚ö†Ô∏è Warning: ${this.systems.length} systems. Approaching 200 limit.`);
                }
            },

            // Initialize 3D map
            initMap() {
                const container = document.getElementById('map-canvas');

                // Scene
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x000000);

                // Camera
                this.camera = new THREE.PerspectiveCamera(
                    75,
                    container.clientWidth / container.clientHeight,
                    0.1,
                    1000
                );
                this.camera.position.set(15, 10, 15);
                this.camera.lookAt(0, 0, 0);

                // Renderer
                this.renderer = new THREE.WebGLRenderer({
                    antialias: true
                });
                this.renderer.setSize(container.clientWidth, container.clientHeight);
                this.renderer.setPixelRatio(window.devicePixelRatio);
                container.appendChild(this.renderer.domElement);

                // Lights
                const ambientLight = new THREE.AmbientLight(0x404040, 2);
                this.scene.add(ambientLight);

                const pointLight = new THREE.PointLight(0x00d9ff, 1, 100);
                pointLight.position.set(10, 10, 10);
                this.scene.add(pointLight);

                // Grid helper
                const gridHelper = new THREE.GridHelper(50, 50, 0x00d9ff, 0x1a2342);
                this.scene.add(gridHelper);

                // Touch controls
                this.setupTouchControls();

                // Handle resize
                window.addEventListener('resize', () => {
                    if (this.camera && this.renderer) {
                        this.camera.aspect = container.clientWidth / container.clientHeight;
                        this.camera.updateProjectionMatrix();
                        this.renderer.setSize(container.clientWidth, container.clientHeight);
                    }
                });

                this.mapInitialized = true;
                this.animate();

                this.addLog('3D map initialized');
            },

            // Setup touch controls for map
            setupTouchControls() {
                const canvas = this.renderer.domElement;
                let isDragging = false;
                let previousTouch = { x: 0, y: 0 };
                let pinchDistance = 0;

                canvas.addEventListener('touchstart', (e) => {
                    if (e.touches.length === 1) {
                        isDragging = true;
                        previousTouch = {
                            x: e.touches[0].clientX,
                            y: e.touches[0].clientY
                        };
                    } else if (e.touches.length === 2) {
                        const dx = e.touches[0].clientX - e.touches[1].clientX;
                        const dy = e.touches[0].clientY - e.touches[1].clientY;
                        pinchDistance = Math.sqrt(dx * dx + dy * dy);
                    }
                });

                canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();

                    if (e.touches.length === 1 && isDragging) {
                        const deltaX = e.touches[0].clientX - previousTouch.x;
                        const deltaY = e.touches[0].clientY - previousTouch.y;

                        // Rotate camera
                        this.camera.position.x -= deltaX * 0.05;
                        this.camera.position.y += deltaY * 0.05;
                        this.camera.lookAt(0, 0, 0);

                        previousTouch = {
                            x: e.touches[0].clientX,
                            y: e.touches[0].clientY
                        };
                    } else if (e.touches.length === 2) {
                        const dx = e.touches[0].clientX - e.touches[1].clientX;
                        const dy = e.touches[0].clientY - e.touches[1].clientY;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        const delta = distance - pinchDistance;

                        // Zoom camera
                        this.camera.position.z -= delta * 0.05;
                        this.camera.position.z = Math.max(5, Math.min(50, this.camera.position.z));

                        pinchDistance = distance;
                    }
                });

                canvas.addEventListener('touchend', () => {
                    isDragging = false;
                });
            },

            // Generate 3D map from systems
            generateMap() {
                if (!this.mapInitialized) {
                    this.initMap();
                }

                // Clear existing systems
                this.scene.children = this.scene.children.filter(
                    child => child instanceof THREE.AmbientLight ||
                             child instanceof THREE.PointLight ||
                             child instanceof THREE.GridHelper
                );

                if (this.systems.length === 0) {
                    this.addLog('No systems to display on map');
                    return;
                }

                // Add each system as a glowing sphere
                this.systems.forEach(system => {
                    // Main sphere
                    const geometry = new THREE.SphereGeometry(0.3, 16, 16);
                    const material = new THREE.MeshBasicMaterial({
                        color: 0x00d9ff,
                        transparent: true,
                        opacity: 0.8
                    });
                    const sphere = new THREE.Mesh(geometry, material);
                    sphere.position.set(system.x, system.y, system.z);
                    sphere.userData = system;
                    this.scene.add(sphere);

                    // Glow effect
                    const glowGeometry = new THREE.SphereGeometry(0.5, 16, 16);
                    const glowMaterial = new THREE.MeshBasicMaterial({
                        color: 0x00d9ff,
                        transparent: true,
                        opacity: 0.2
                    });
                    const glow = new THREE.Mesh(glowGeometry, glowMaterial);
                    glow.position.copy(sphere.position);
                    this.scene.add(glow);
                });

                this.addLog(`Map generated with ${this.systems.length} systems`);

                // Show success message
                const mapInfo = document.getElementById('map-info');
                mapInfo.innerHTML = `
                    <div style="color: var(--success); font-weight: bold; margin-bottom: 8px;">
                        ‚úÖ Map Generated Successfully
                    </div>
                    <div style="color: var(--text-secondary); font-size: 14px;">
                        ${this.systems.length} systems rendered<br>
                        Use pinch to zoom, swipe to rotate
                    </div>
                `;
                mapInfo.classList.add('show');
                setTimeout(() => {
                    mapInfo.classList.remove('show');
                }, 3000);
            },

            // Animation loop
            animate() {
                if (!this.renderer) return;

                requestAnimationFrame(() => this.animate());

                // Slowly rotate the view
                if (this.camera) {
                    const time = Date.now() * 0.0001;
                    this.camera.position.x = Math.sin(time) * 15;
                    this.camera.position.z = Math.cos(time) * 15;
                    this.camera.lookAt(0, 0, 0);
                }

                this.renderer.render(this.scene, this.camera);
            },

            // Reset map view
            resetMapView() {
                if (this.camera) {
                    this.camera.position.set(0, 5, 15);
                    this.camera.lookAt(0, 0, 0);
                    this.addLog('Map view reset');
                }
            },

            // Toggle map info
            toggleMapInfo() {
                const mapInfo = document.getElementById('map-info');
                if (mapInfo.classList.contains('show')) {
                    mapInfo.classList.remove('show');
                } else {
                    mapInfo.innerHTML = `
                        <div style="font-weight: bold; margin-bottom: 8px; color: var(--accent-cyan);">
                            üó∫Ô∏è Map Controls
                        </div>
                        <div style="font-size: 14px; line-height: 1.6;">
                            <strong>Pinch:</strong> Zoom in/out<br>
                            <strong>Swipe:</strong> Rotate view<br>
                            <strong>Systems:</strong> ${this.systems.length} rendered<br>
                            <strong>Tip:</strong> Use "Reset View" to return to default position
                        </div>
                    `;
                    mapInfo.classList.add('show');
                }
            },

            // Add log entry
            addLog(message) {
                const logEntry = {
                    time: new Date().toISOString(),
                    message: message
                };

                this.logs.unshift(logEntry);

                // Keep only last 50 logs
                if (this.logs.length > 50) {
                    this.logs = this.logs.slice(0, 50);
                }

                this.saveToStorage();
                this.renderLogs();
            },

            // Render logs
            renderLogs() {
                const container = document.getElementById('logs-list');

                if (this.logs.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">No activity logs yet</div>';
                    return;
                }

                container.innerHTML = this.logs.map(log => {
                    const date = new Date(log.time);
                    const timeStr = date.toLocaleTimeString();
                    const dateStr = date.toLocaleDateString();

                    return `
                        <div class="log-entry">
                            <div class="log-time">${dateStr} ${timeStr}</div>
                            <div class="log-message">${log.message}</div>
                        </div>
                    `;
                }).join('');
            },

            // Clear logs
            clearLogs() {
                if (confirm('Clear all activity logs?')) {
                    this.logs = [];
                    this.saveToStorage();
                    this.renderLogs();
                    this.addLog('Logs cleared');
                }
            },

            // Export data as JSON
            exportData() {
                if (this.systems.length === 0) {
                    alert('No systems to export. Add some systems first!');
                    return;
                }

                const exportData = {
                    _meta: {
                        version: "1.0.0",
                        exported_at: new Date().toISOString(),
                        device: "Mobile Explorer",
                        system_count: this.systems.length
                    }
                };

                // Add systems by name (matching desktop format)
                this.systems.forEach(system => {
                    exportData[system.name] = system;
                });

                const jsonStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = `haven_data_${Date.now()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                this.addLog(`Exported ${this.systems.length} systems to JSON`);

                // Show success message
                alert(`‚úÖ Exported ${this.systems.length} systems!\n\nCheck your Downloads folder for the JSON file.`);
            },

            // Import data from JSON
            importData(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);

                        // Parse different formats
                        let importedSystems = [];

                        if (Array.isArray(data)) {
                            importedSystems = data;
                        } else if (data._meta) {
                            // Desktop format - extract systems
                            Object.keys(data).forEach(key => {
                                if (key !== '_meta') {
                                    importedSystems.push(data[key]);
                                }
                            });
                        }

                        if (importedSystems.length === 0) {
                            alert('No systems found in the JSON file.');
                            return;
                        }

                        if (confirm(`Import ${importedSystems.length} systems?\n\nThis will replace your current data.`)) {
                            this.systems = importedSystems;
                            this.saveToStorage();
                            this.renderSystemsList();
                            this.updateSystemCount();
                            this.addLog(`Imported ${importedSystems.length} systems from JSON`);

                            alert(`‚úÖ Successfully imported ${importedSystems.length} systems!`);
                        }
                    } catch (error) {
                        alert('Error reading JSON file. Please check the file format.');
                        console.error('Import error:', error);
                    }
                };
                reader.readAsText(file);

                // Reset input
                event.target.value = '';
            },

            // Clear all data
            clearAllData() {
                if (confirm('‚ö†Ô∏è WARNING: This will delete all systems and logs!\n\nAre you absolutely sure?')) {
                    if (confirm('This cannot be undone. Continue?')) {
                        this.systems = [];
                        this.logs = [];
                        this.saveToStorage();
                        this.renderSystemsList();
                        this.renderLogs();
                        this.updateSystemCount();
                        this.clearForm();

                        alert('All data has been cleared.');
                        this.addLog('All data cleared by user');
                    }
                }
            },

            // Planet/Moon Management Functions
            currentPlanets: [],

            openPlanetModal() {
                document.getElementById('planet-modal').classList.add('show');
                this.renderPlanetsList();
            },

            closePlanetModal() {
                document.getElementById('planet-modal').classList.remove('show');
                this.updatePlanetsSummary();
            },

            addPlanet() {
                this.openPlanetEntryModal(false, -1, -1);
            },

            addMoon(planetIndex) {
                this.openPlanetEntryModal(true, planetIndex, -1);
            },

            openPlanetEntryModal(isMoon, planetIndex, editIndex) {
                const modal = document.getElementById('planet-entry-modal');
                const titleEl = document.getElementById('planet-entry-title');
                
                // Clear form
                document.getElementById('planet-entry-form').reset();
                document.getElementById('planet-edit-index').value = editIndex;
                document.getElementById('is-moon').value = isMoon;
                document.getElementById('parent-planet-index').value = planetIndex;

                // Set title
                if (editIndex >= 0) {
                    titleEl.textContent = isMoon ? 'Edit Moon' : 'Edit Planet';
                    // Load existing data
                    if (isMoon && planetIndex >= 0) {
                        const moon = this.currentPlanets[planetIndex].moons[editIndex];
                        this.populatePlanetForm(moon);
                    } else if (!isMoon) {
                        const planet = this.currentPlanets[editIndex];
                        this.populatePlanetForm(planet);
                    }
                } else {
                    titleEl.textContent = isMoon ? 'Add Moon' : 'Add Planet';
                }

                modal.classList.add('show');
            },

            closePlanetEntryModal() {
                document.getElementById('planet-entry-modal').classList.remove('show');
            },

            populatePlanetForm(data) {
                document.getElementById('planet-entry-name').value = data.name || '';
                document.getElementById('planet-entry-type').value = data.type || '';
                document.getElementById('planet-entry-fauna').value = data.fauna || '';
                document.getElementById('planet-entry-flora').value = data.flora || '';
                document.getElementById('planet-entry-sentinels').value = data.sentinels || '';
                document.getElementById('planet-entry-resources').value = data.resources || '';
            },

            savePlanetEntry(e) {
                e.preventDefault();

                const planetData = {
                    name: document.getElementById('planet-entry-name').value.trim(),
                    type: document.getElementById('planet-entry-type').value,
                    fauna: document.getElementById('planet-entry-fauna').value,
                    flora: document.getElementById('planet-entry-flora').value,
                    sentinels: document.getElementById('planet-entry-sentinels').value,
                    resources: document.getElementById('planet-entry-resources').value.trim(),
                    moons: []
                };

                if (!planetData.name) {
                    alert('Please enter a name');
                    return;
                }

                const editIndex = parseInt(document.getElementById('planet-edit-index').value);
                const isMoon = document.getElementById('is-moon').value === 'true';
                const planetIndex = parseInt(document.getElementById('parent-planet-index').value);

                if (isMoon && planetIndex >= 0) {
                    // Save moon
                    if (editIndex >= 0) {
                        this.currentPlanets[planetIndex].moons[editIndex] = planetData;
                    } else {
                        if (!this.currentPlanets[planetIndex].moons) {
                            this.currentPlanets[planetIndex].moons = [];
                        }
                        this.currentPlanets[planetIndex].moons.push(planetData);
                    }
                } else {
                    // Save planet
                    if (editIndex >= 0) {
                        // Preserve existing moons when editing
                        planetData.moons = this.currentPlanets[editIndex].moons || [];
                        this.currentPlanets[editIndex] = planetData;
                    } else {
                        this.currentPlanets.push(planetData);
                    }
                }

                this.closePlanetEntryModal();
                this.renderPlanetsList();
            },

            deletePlanet(index) {
                const planet = this.currentPlanets[index];
                const moonCount = planet.moons ? planet.moons.length : 0;
                const confirmMsg = moonCount > 0 
                    ? `Delete "${planet.name}" and its ${moonCount} moon(s)?`
                    : `Delete "${planet.name}"?`;

                if (confirm(confirmMsg)) {
                    this.currentPlanets.splice(index, 1);
                    this.renderPlanetsList();
                }
            },

            deleteMoon(planetIndex, moonIndex) {
                const moon = this.currentPlanets[planetIndex].moons[moonIndex];
                if (confirm(`Delete moon "${moon.name}"?`)) {
                    this.currentPlanets[planetIndex].moons.splice(moonIndex, 1);
                    this.renderPlanetsList();
                }
            },

            renderPlanetsList() {
                const container = document.getElementById('planets-list-container');
                
                if (this.currentPlanets.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 24px; color: var(--text-secondary);">No planets added yet. Click "Add Planet" to get started.</div>';
                    return;
                }

                let html = '';
                this.currentPlanets.forEach((planet, pIndex) => {
                    const moonCount = planet.moons ? planet.moons.length : 0;
                    html += `
                        <div style="border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 12px; background: var(--bg-card);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-weight: 600; font-size: 15px;">üåç ${planet.name}</div>
                                <div>
                                    <button onclick="App.openPlanetEntryModal(false, -1, ${pIndex})" class="icon-btn" title="Edit Planet">‚úèÔ∏è</button>
                                    <button onclick="App.deletePlanet(${pIndex})" class="icon-btn" title="Delete Planet">üóëÔ∏è</button>
                                </div>
                            </div>
                            ${planet.type ? `<div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">Type: ${planet.type}</div>` : ''}
                            ${planet.fauna || planet.flora || planet.sentinels ? `
                                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">
                                    ${planet.fauna ? `Fauna: ${planet.fauna}` : ''}
                                    ${planet.flora ? ` ‚Ä¢ Flora: ${planet.flora}` : ''}
                                    ${planet.sentinels ? ` ‚Ä¢ Sentinels: ${planet.sentinels}` : ''}
                                </div>
                            ` : ''}
                            ${planet.resources ? `<div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">Resources: ${planet.resources}</div>` : ''}
                            
                            <!-- Moons section -->
                            ${moonCount > 0 ? `
                                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
                                    <div style="font-weight: 600; font-size: 14px; margin-bottom: 8px; color: var(--text-secondary);">üåô Moons (${moonCount})</div>
                                    ${planet.moons.map((moon, mIndex) => `
                                        <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 8px; margin-bottom: 6px;">
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <div style="font-size: 14px;">${moon.name}</div>
                                                <div>
                                                    <button onclick="App.openPlanetEntryModal(true, ${pIndex}, ${mIndex})" class="icon-btn" title="Edit Moon">‚úèÔ∏è</button>
                                                    <button onclick="App.deleteMoon(${pIndex}, ${mIndex})" class="icon-btn" title="Delete Moon">üóëÔ∏è</button>
                                                </div>
                                            </div>
                                            ${moon.type ? `<div style="font-size: 12px; color: var(--text-secondary);">Type: ${moon.type}</div>` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            
                            <button onclick="App.addMoon(${pIndex})" class="btn btn-secondary" style="width: 100%; margin-top: 8px; font-size: 13px;">
                                üåô Add Moon
                            </button>
                        </div>
                    `;
                });

                container.innerHTML = html;
            },

            updatePlanetsSummary() {
                const summaryEl = document.getElementById('planets-summary');
                const planetCount = this.currentPlanets.length;
                const moonCount = this.currentPlanets.reduce((total, p) => total + (p.moons ? p.moons.length : 0), 0);

                if (planetCount === 0) {
                    summaryEl.textContent = 'No planets added yet';
                } else {
                    summaryEl.textContent = `${planetCount} planet${planetCount !== 1 ? 's' : ''}, ${moonCount} moon${moonCount !== 1 ? 's' : ''}`;
                }
            },

            // Save to localStorage
            saveToStorage() {
                try {
                    localStorage.setItem('havenSystems', JSON.stringify(this.systems));
                    localStorage.setItem('havenLogs', JSON.stringify(this.logs));
                } catch (error) {
                    console.error('Error saving to storage:', error);
                    alert('Error saving data. Storage may be full.');
                }
            },

            // Load from localStorage
            loadFromStorage() {
                try {
                    const systemsData = localStorage.getItem('havenSystems');
                    const logsData = localStorage.getItem('havenLogs');

                    if (systemsData) {
                        this.systems = JSON.parse(systemsData);
                    }

                    if (logsData) {
                        this.logs = JSON.parse(logsData);
                    }
                } catch (error) {
                    console.error('Error loading from storage:', error);
                    this.systems = [];
                    this.logs = [];
                }
            }
        };

        // Initialize app when page loads
        window.addEventListener('DOMContentLoaded', () => {
            App.init();
        });

        // Register service worker for offline support (if HTTPS)
        if ('serviceWorker' in navigator && location.protocol === 'https:') {
            window.addEventListener('load', () => {
                // Simple inline service worker for caching
                const swCode = `
                    self.addEventListener('install', (e) => {
                        e.waitUntil(
                            caches.open('haven-v1').then((cache) => {
                                return cache.addAll(['/']);
                            })
                        );
                    });

                    self.addEventListener('fetch', (e) => {
                        e.respondWith(
                            caches.match(e.request).then((response) => {
                                return response || fetch(e.request);
                            })
                        );
                    });
                `;

                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);

                navigator.serviceWorker.register(swUrl).then(() => {
                    console.log('Service Worker registered for offline support');
                }).catch((error) => {
                    console.log('Service Worker registration failed:', error);
                });
            });
        }
    </script>
</body>
</html>