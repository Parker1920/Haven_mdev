<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Haven Mobile">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0a0e27">
    <title>Haven Mobile Map</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiSGF2ZW4gTW9iaWxlIE1hcCIsInNob3J0X25hbWUiOiJIYXZlbiIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjMGEwZTI3IiwidGhlbWVfY29sb3IiOiIjMGEwZTI3IiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2UvcG5nO2Jhc2U2NCxpVkJPUncwS0dnb0FBQUFOU1VoRVVnQUFBQUVBQUFBQkNBUUFBQUMxSEF3Q0FBQUFDMGxFUVZSNDJtUDgveDhBQXdNQ0FPNHNVdVVBQUFBQVNVVk9SSzVDWUlJPSIsInNpemVzIjoiNTEyeDUxMiIsInR5cGUiOiJpbWFnZS9wbmcifV19">

    <!-- iOS Icons -->
    <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMCAO4sUuUAAAAASUVORK5CYII=">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --bg-dark: #0a0e27;
            --bg-card: #141b3d;
            --accent-cyan: #00d9ff;
            --accent-purple: #9d4edd;
            --accent-pink: #ff006e;
            --text-primary: #ffffff;
            --text-secondary: #8892b0;
            --success: #00ff88;
            --warning: #ffb703;
            --error: #ff006e;
            --glass: rgba(26, 35, 66, 0.8);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #1a1f3a 100%);
            color: var(--text-primary);
            overflow-x: hidden;
            min-height: 100vh;
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* Header */
        .header {
            background: var(--glass);
            backdrop-filter: blur(10px);
            padding: max(env(safe-area-inset-top), 12px) 16px 12px;
            border-bottom: 1px solid rgba(0, 217, 255, 0.2);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent-cyan);
            text-align: center;
            text-shadow: 0 0 10px rgba(0, 217, 255, 0.5);
        }

        /* Navigation Tabs */
        .tabs {
            display: flex;
            background: var(--bg-card);
            border-bottom: 2px solid var(--accent-cyan);
            position: sticky;
            top: calc(max(env(safe-area-inset-top), 12px) + 44px);
            z-index: 99;
        }

        .tab {
            flex: 1;
            padding: 14px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            color: var(--accent-cyan);
            border-bottom-color: var(--accent-cyan);
            background: rgba(0, 217, 255, 0.1);
        }

        /* Content Views */
        .view {
            display: none;
            padding: 16px;
            animation: fadeIn 0.3s;
        }

        .view.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* 2D Map View */
        .map-container {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid rgba(0, 217, 255, 0.3);
        }

        #map-canvas {
            width: 100%;
            height: 400px;
            border-radius: 8px;
            background: radial-gradient(circle, #0a0e27 0%, #050819 100%);
            border: 1px solid rgba(0, 217, 255, 0.2);
            touch-action: none;
        }

        .map-controls {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .map-btn {
            flex: 1;
            min-width: 80px;
            padding: 10px;
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid var(--accent-cyan);
            border-radius: 8px;
            color: var(--accent-cyan);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        /* List View */
        .search-bar {
            background: var(--bg-card);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            border: 1px solid rgba(0, 217, 255, 0.3);
        }

        .search-bar input {
            width: 100%;
            padding: 12px;
            background: var(--bg-dark);
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 15px;
        }

        .system-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid rgba(0, 217, 255, 0.3);
            cursor: pointer;
            transition: all 0.3s;
        }

        .system-card:active {
            transform: scale(0.98);
            border-color: var(--accent-cyan);
        }

        .system-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .system-name {
            font-size: 18px;
            font-weight: 700;
            color: var(--accent-cyan);
        }

        .region-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            background: rgba(157, 78, 221, 0.2);
            color: var(--accent-purple);
            border: 1px solid var(--accent-purple);
        }

        .system-coords {
            color: var(--text-secondary);
            font-size: 13px;
            margin-bottom: 8px;
        }

        .planet-count {
            color: var(--success);
            font-size: 12px;
        }

        /* Add System Form */
        .form-section {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid rgba(0, 217, 255, 0.3);
        }

        .form-section h3 {
            color: var(--accent-cyan);
            font-size: 16px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(0, 217, 255, 0.2);
        }

        .form-group {
            margin-bottom: 14px;
        }

        .form-group label {
            display: block;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            background: var(--bg-dark);
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 15px;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .coords-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 12px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-cyan), #0099cc);
            color: var(--bg-dark);
        }

        .btn-secondary {
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid var(--accent-cyan);
            color: var(--accent-cyan);
        }

        .btn-danger {
            background: rgba(255, 0, 110, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
        }

        /* Planet/Moon List */
        .planet-list {
            margin-top: 16px;
        }

        .planet-item {
            background: var(--bg-dark);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid rgba(0, 217, 255, 0.2);
        }

        .planet-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .planet-name {
            font-weight: 600;
            color: var(--accent-cyan);
        }

        .moon-item {
            background: rgba(157, 78, 221, 0.1);
            padding: 8px 12px;
            border-radius: 6px;
            margin: 8px 0 0 20px;
            border-left: 2px solid var(--accent-purple);
            font-size: 13px;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: calc(env(safe-area-inset-bottom) + 80px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--glass);
            backdrop-filter: blur(10px);
            color: var(--text-primary);
            padding: 12px 24px;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 600;
            border: 1px solid var(--accent-cyan);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .toast.show {
            opacity: 1;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state h3 {
            color: var(--accent-cyan);
            margin-bottom: 8px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 200;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 100%;
            border: 2px solid var(--accent-cyan);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent-cyan);
        }

        .modal-close {
            background: rgba(255, 0, 110, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
        }

        /* Settings View */
        .settings-item {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid rgba(0, 217, 255, 0.3);
        }

        .settings-item h4 {
            color: var(--accent-cyan);
            font-size: 15px;
            margin-bottom: 8px;
        }

        .settings-item p {
            color: var(--text-secondary);
            font-size: 13px;
            margin-bottom: 12px;
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>‚≠ê HAVEN MOBILE MAP</h1>
    </div>

    <!-- Navigation Tabs -->
    <div class="tabs">
        <button class="tab active" data-view="map">üìç Map</button>
        <button class="tab" data-view="list">üìã List</button>
        <button class="tab" data-view="add">‚ûï Add</button>
        <button class="tab" data-view="settings">‚öôÔ∏è Data</button>
    </div>

    <!-- Map View -->
    <div class="view active" id="map-view">
        <div class="map-container">
            <svg id="map-canvas"></svg>
            <div class="map-controls">
                <button class="map-btn" onclick="zoomIn()">üîç Zoom In</button>
                <button class="map-btn" onclick="zoomOut()">üîç Zoom Out</button>
                <button class="map-btn" onclick="resetView()">üéØ Reset</button>
            </div>
        </div>
        <div id="map-stats" style="text-align: center; color: var(--text-secondary); font-size: 13px;"></div>
    </div>

    <!-- List View -->
    <div class="view" id="list-view">
        <div class="search-bar">
            <input type="text" id="search-input" placeholder="üîç Search systems..." oninput="filterSystems()">
        </div>
        <div id="systems-list"></div>
    </div>

    <!-- Add System View -->
    <div class="view" id="add-view">
        <form id="system-form" onsubmit="saveSystem(event)">
            <!-- System Info -->
            <div class="form-section">
                <h3>System Information</h3>

                <div class="form-group">
                    <label>System Name *</label>
                    <input type="text" id="system-name" required placeholder="e.g., Alpha Centauri">
                </div>

                <div class="form-group">
                    <label>Region *</label>
                    <input type="text" id="system-region" required placeholder="e.g., Euclid Core">
                </div>

                <div class="form-group">
                    <label>Coordinates *</label>
                    <div class="coords-grid">
                        <input type="number" id="coord-x" step="0.01" required placeholder="X">
                        <input type="number" id="coord-y" step="0.01" required placeholder="Y">
                        <input type="number" id="coord-z" step="0.01" required placeholder="Z">
                    </div>
                </div>

                <div class="form-group">
                    <label>Attributes / Notes</label>
                    <textarea id="system-attributes" placeholder="e.g., Trade hub, Rich resources..."></textarea>
                </div>
            </div>

            <!-- Planets Section -->
            <div class="form-section">
                <h3>Planets</h3>
                <div id="planets-container"></div>
                <button type="button" class="btn btn-secondary" onclick="addPlanet()">‚ûï Add Planet</button>
            </div>

            <!-- Action Buttons -->
            <button type="submit" class="btn btn-primary">üíæ Save System</button>
            <button type="button" class="btn btn-secondary" onclick="clearForm()">üóëÔ∏è Clear Form</button>
        </form>
    </div>

    <!-- Settings/Data View -->
    <div class="view" id="settings-view">
        <div class="settings-item">
            <h4>üì§ Export Data</h4>
            <p>Download your systems data as JSON file to share or backup.</p>
            <button class="btn btn-primary" onclick="exportData()">Download JSON</button>
        </div>

        <div class="settings-item">
            <h4>üì• Import Data</h4>
            <p>Load systems data from a JSON file.</p>
            <input type="file" id="import-file" accept=".json" style="display: none" onchange="importData(event)">
            <button class="btn btn-secondary" onclick="document.getElementById('import-file').click()">Choose JSON File</button>
        </div>

        <div class="settings-item">
            <h4>üìä Statistics</h4>
            <p id="stats-info">Loading...</p>
        </div>

        <div class="settings-item">
            <h4>üóëÔ∏è Clear All Data</h4>
            <p>Delete all systems data. This cannot be undone!</p>
            <button class="btn btn-danger" onclick="confirmClearData()">Clear All Data</button>
        </div>

        <div class="settings-item">
            <h4>‚ÑπÔ∏è About</h4>
            <p style="color: var(--text-primary); line-height: 1.6;">
                <strong>Haven Mobile Map v1.0</strong><br>
                A mobile companion for cataloging star systems.<br>
                <br>
                Export your JSON files to upload to the master Haven Galaxy map on desktop!<br>
                <br>
                Works on all phones: iPhone, Android, Samsung, and more.
            </p>
        </div>
    </div>

    <!-- System Detail Modal -->
    <div class="modal" id="system-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modal-system-name"></div>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div id="modal-system-details"></div>
            <button class="btn btn-danger" onclick="deleteSystem()">Delete System</button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>
        // === Data Storage ===
        const STORAGE_KEY = 'haven_mobile_systems';
        let systemsData = [];
        let currentEditingSystem = null;

        // Map visualization state
        let mapScale = 1;
        let mapOffsetX = 0;
        let mapOffsetY = 0;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            renderMap();
            renderList();
            updateStats();
            showToast('Haven Mobile Map loaded! Start by adding a system.');
        });

        // === Tab Navigation ===
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const viewId = this.dataset.view;

                // Update tabs
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');

                // Update views
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.getElementById(viewId + '-view').classList.add('active');

                // Refresh content
                if (viewId === 'map') renderMap();
                if (viewId === 'list') renderList();
                if (viewId === 'settings') updateStats();
            });
        });

        // === Data Management ===
        function loadData() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    systemsData = JSON.parse(stored);
                } else {
                    systemsData = [];
                }
            } catch (e) {
                console.error('Failed to load data:', e);
                systemsData = [];
            }
        }

        function saveData() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(systemsData));
                return true;
            } catch (e) {
                console.error('Failed to save data:', e);
                showToast('‚ùå Failed to save data');
                return false;
            }
        }

        // === 2D Map Rendering ===
        function renderMap() {
            const svg = document.getElementById('map-canvas');
            const width = svg.clientWidth;
            const height = svg.clientHeight;

            svg.setAttribute('viewBox', `${-width/2} ${-height/2} ${width} ${height}`);
            svg.innerHTML = '';

            if (systemsData.length === 0) {
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', '0');
                text.setAttribute('y', '0');
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('fill', '#8892b0');
                text.setAttribute('font-size', '14');
                text.textContent = 'No systems yet. Add one to see it here!';
                svg.appendChild(text);

                document.getElementById('map-stats').textContent = 'No systems to display';
                return;
            }

            // Draw grid
            for (let i = -10; i <= 10; i++) {
                const lineX = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                lineX.setAttribute('x1', i * 30);
                lineX.setAttribute('y1', -height/2);
                lineX.setAttribute('x2', i * 30);
                lineX.setAttribute('y2', height/2);
                lineX.setAttribute('stroke', 'rgba(0, 217, 255, 0.1)');
                lineX.setAttribute('stroke-width', '1');
                svg.appendChild(lineX);

                const lineY = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                lineY.setAttribute('x1', -width/2);
                lineY.setAttribute('y1', i * 30);
                lineY.setAttribute('x2', width/2);
                lineY.setAttribute('y2', i * 30);
                lineY.setAttribute('stroke', 'rgba(0, 217, 255, 0.1)');
                lineY.setAttribute('stroke-width', '1');
                svg.appendChild(lineY);
            }

            // Draw axes
            const axisX = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            axisX.setAttribute('x1', -width/2);
            axisX.setAttribute('y1', 0);
            axisX.setAttribute('x2', width/2);
            axisX.setAttribute('y2', 0);
            axisX.setAttribute('stroke', '#00d9ff');
            axisX.setAttribute('stroke-width', '2');
            svg.appendChild(axisX);

            const axisY = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            axisY.setAttribute('x1', 0);
            axisY.setAttribute('y1', -height/2);
            axisY.setAttribute('x2', 0);
            axisY.setAttribute('y2', height/2);
            axisY.setAttribute('stroke', '#00d9ff');
            axisY.setAttribute('stroke-width', '2');
            svg.appendChild(axisY);

            // Draw systems
            systemsData.forEach((system, index) => {
                const x = system.x * 30;
                const y = -system.y * 30; // Invert Y for screen coordinates

                // System circle
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', x);
                circle.setAttribute('cy', y);
                circle.setAttribute('r', '8');
                circle.setAttribute('fill', '#00d9ff');
                circle.setAttribute('stroke', '#9d4edd');
                circle.setAttribute('stroke-width', '2');
                circle.style.cursor = 'pointer';
                circle.onclick = () => showSystemDetail(index);
                svg.appendChild(circle);

                // System name
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', x);
                text.setAttribute('y', y - 15);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('fill', '#ffffff');
                text.setAttribute('font-size', '10');
                text.setAttribute('font-weight', 'bold');
                text.textContent = system.name;
                svg.appendChild(text);
            });

            document.getElementById('map-stats').textContent =
                `Showing ${systemsData.length} system${systemsData.length !== 1 ? 's' : ''} on 2D map (X/Y plane)`;
        }

        function zoomIn() {
            mapScale *= 1.2;
            showToast('Zoomed in');
        }

        function zoomOut() {
            mapScale /= 1.2;
            showToast('Zoomed out');
        }

        function resetView() {
            mapScale = 1;
            mapOffsetX = 0;
            mapOffsetY = 0;
            renderMap();
            showToast('View reset');
        }

        // === List View ===
        function renderList() {
            const container = document.getElementById('systems-list');

            if (systemsData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                        <h3>No Systems Yet</h3>
                        <p>Tap the ‚ûï Add tab to create your first system!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = systemsData.map((system, index) => {
                const planetCount = system.planets ? system.planets.length : 0;
                return `
                    <div class="system-card" onclick="showSystemDetail(${index})">
                        <div class="system-card-header">
                            <div class="system-name">${system.name}</div>
                            <div class="region-badge">${system.region}</div>
                        </div>
                        <div class="system-coords">
                            üìç Coordinates: X: ${system.x}, Y: ${system.y}, Z: ${system.z}
                        </div>
                        ${planetCount > 0 ? `<div class="planet-count">üåç ${planetCount} planet${planetCount !== 1 ? 's' : ''}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function filterSystems() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const cards = document.querySelectorAll('.system-card');

            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(query) ? 'block' : 'none';
            });
        }

        // === System Detail Modal ===
        function showSystemDetail(index) {
            const system = systemsData[index];
            currentEditingSystem = index;

            document.getElementById('modal-system-name').textContent = system.name;

            let html = `
                <div style="color: var(--text-secondary); font-size: 14px; line-height: 1.8;">
                    <p><strong>Region:</strong> ${system.region}</p>
                    <p><strong>Coordinates:</strong><br>X: ${system.x}, Y: ${system.y}, Z: ${system.z}</p>
                    ${system.attributes ? `<p><strong>Attributes:</strong><br>${system.attributes}</p>` : ''}

                    ${system.planets && system.planets.length > 0 ? `
                        <h4 style="color: var(--accent-cyan); margin-top: 16px; margin-bottom: 8px;">Planets</h4>
                        ${system.planets.map(planet => {
                            if (typeof planet === 'string') {
                                return `<div class="planet-item"><div class="planet-name">üåç ${planet}</div></div>`;
                            } else {
                                let planetHtml = `
                                    <div class="planet-item">
                                        <div class="planet-name">üåç ${planet.name}</div>
                                        ${planet.sentinel ? `<div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Sentinel: ${planet.sentinel}</div>` : ''}
                                        ${planet.fauna ? `<div style="font-size: 12px; color: var(--text-secondary);">Fauna: ${planet.fauna}</div>` : ''}
                                        ${planet.flora ? `<div style="font-size: 12px; color: var(--text-secondary);">Flora: ${planet.flora}</div>` : ''}
                                        ${planet.materials ? `<div style="font-size: 12px; color: var(--text-secondary);">Materials: ${planet.materials}</div>` : ''}
                                        ${planet.notes ? `<div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px; font-style: italic;">${planet.notes}</div>` : ''}
                                `;

                                if (planet.moons && planet.moons.length > 0) {
                                    planetHtml += planet.moons.map(moon => `
                                        <div class="moon-item">üåô ${moon.name || moon}</div>
                                    `).join('');
                                }

                                planetHtml += '</div>';
                                return planetHtml;
                            }
                        }).join('')}
                    ` : '<p><em>No planets recorded</em></p>'}
                </div>
            `;

            document.getElementById('modal-system-details').innerHTML = html;
            document.getElementById('system-modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('system-modal').classList.remove('active');
            currentEditingSystem = null;
        }

        function deleteSystem() {
            if (currentEditingSystem === null) return;

            if (confirm('Delete this system? This cannot be undone!')) {
                systemsData.splice(currentEditingSystem, 1);
                saveData();
                closeModal();
                renderMap();
                renderList();
                updateStats();
                showToast('‚úÖ System deleted');
            }
        }

        // === Add System Form ===
        let planetCounter = 0;

        function addPlanet() {
            planetCounter++;
            const container = document.getElementById('planets-container');

            const planetDiv = document.createElement('div');
            planetDiv.className = 'planet-item';
            planetDiv.id = `planet-${planetCounter}`;
            planetDiv.innerHTML = `
                <div class="planet-item-header">
                    <div class="planet-name">Planet ${planetCounter}</div>
                    <button type="button" class="map-btn" style="flex: none; width: auto; padding: 6px 12px;"
                            onclick="removePlanet(${planetCounter})">Remove</button>
                </div>
                <div style="margin-top: 8px;">
                    <input type="text" placeholder="Planet Name *" id="planet-name-${planetCounter}"
                           style="width: 100%; padding: 8px; margin-bottom: 6px; background: var(--bg-dark);
                                  border: 1px solid rgba(0, 217, 255, 0.3); border-radius: 6px; color: var(--text-primary);">
                    <input type="text" placeholder="Sentinel Level" id="planet-sentinel-${planetCounter}"
                           style="width: 100%; padding: 8px; margin-bottom: 6px; background: var(--bg-dark);
                                  border: 1px solid rgba(0, 217, 255, 0.3); border-radius: 6px; color: var(--text-primary);">
                    <input type="text" placeholder="Fauna Count" id="planet-fauna-${planetCounter}"
                           style="width: 100%; padding: 8px; margin-bottom: 6px; background: var(--bg-dark);
                                  border: 1px solid rgba(0, 217, 255, 0.3); border-radius: 6px; color: var(--text-primary);">
                    <input type="text" placeholder="Flora Level" id="planet-flora-${planetCounter}"
                           style="width: 100%; padding: 8px; margin-bottom: 6px; background: var(--bg-dark);
                                  border: 1px solid rgba(0, 217, 255, 0.3); border-radius: 6px; color: var(--text-primary);">
                    <input type="text" placeholder="Materials" id="planet-materials-${planetCounter}"
                           style="width: 100%; padding: 8px; margin-bottom: 6px; background: var(--bg-dark);
                                  border: 1px solid rgba(0, 217, 255, 0.3); border-radius: 6px; color: var(--text-primary);">
                    <textarea placeholder="Notes" id="planet-notes-${planetCounter}"
                              style="width: 100%; padding: 8px; min-height: 50px; background: var(--bg-dark);
                                     border: 1px solid rgba(0, 217, 255, 0.3); border-radius: 6px; color: var(--text-primary);"></textarea>
                    <button type="button" class="btn btn-secondary" style="margin-top: 8px; font-size: 13px; padding: 8px;"
                            onclick="addMoon(${planetCounter})">‚ûï Add Moon</button>
                    <div id="moons-${planetCounter}"></div>
                </div>
            `;

            container.appendChild(planetDiv);
            showToast('Planet added');
        }

        function removePlanet(id) {
            const elem = document.getElementById(`planet-${id}`);
            if (elem) elem.remove();
            showToast('Planet removed');
        }

        function addMoon(planetId) {
            const moonName = prompt('Moon name:');
            if (!moonName) return;

            const moonsContainer = document.getElementById(`moons-${planetId}`);
            const moonDiv = document.createElement('div');
            moonDiv.className = 'moon-item';
            moonDiv.innerHTML = `üåô ${moonName}`;
            moonsContainer.appendChild(moonDiv);

            showToast('Moon added');
        }

        function saveSystem(event) {
            event.preventDefault();

            // Get system data
            const name = document.getElementById('system-name').value.trim();
            const region = document.getElementById('system-region').value.trim();
            const x = parseFloat(document.getElementById('coord-x').value);
            const y = parseFloat(document.getElementById('coord-y').value);
            const z = parseFloat(document.getElementById('coord-z').value);
            const attributes = document.getElementById('system-attributes').value.trim();

            if (!name || !region || isNaN(x) || isNaN(y) || isNaN(z)) {
                showToast('‚ùå Please fill all required fields');
                return;
            }

            // Generate ID
            const id = `SYS_${region.toUpperCase().replace(/\s+/g, '_')}_${Date.now()}`;

            // Get planets
            const planets = [];
            const planetElements = document.querySelectorAll('[id^="planet-name-"]');
            planetElements.forEach(elem => {
                const planetId = elem.id.split('-')[2];
                const planetName = elem.value.trim();
                if (planetName) {
                    const planet = {
                        name: planetName,
                        sentinel: document.getElementById(`planet-sentinel-${planetId}`)?.value.trim() || '',
                        fauna: document.getElementById(`planet-fauna-${planetId}`)?.value.trim() || '',
                        flora: document.getElementById(`planet-flora-${planetId}`)?.value.trim() || '',
                        materials: document.getElementById(`planet-materials-${planetId}`)?.value.trim() || '',
                        notes: document.getElementById(`planet-notes-${planetId}`)?.value.trim() || '',
                        moons: []
                    };

                    // Get moons for this planet
                    const moonsContainer = document.getElementById(`moons-${planetId}`);
                    if (moonsContainer) {
                        const moonDivs = moonsContainer.querySelectorAll('.moon-item');
                        moonDivs.forEach(moonDiv => {
                            const moonName = moonDiv.textContent.replace('üåô ', '').trim();
                            if (moonName) {
                                planet.moons.push({ name: moonName });
                            }
                        });
                    }

                    planets.push(planet);
                }
            });

            // Create system object
            const system = {
                id: id,
                name: name,
                region: region,
                x: x,
                y: y,
                z: z,
                attributes: attributes,
                planets: planets,
                planets_names: planets.map(p => p.name)
            };

            // Save
            systemsData.push(system);
            saveData();

            // Clear form and show success
            clearForm();
            renderMap();
            renderList();
            updateStats();
            showToast('‚úÖ System saved successfully!');

            // Switch to map view
            document.querySelector('[data-view="map"]').click();
        }

        function clearForm() {
            document.getElementById('system-form').reset();
            document.getElementById('planets-container').innerHTML = '';
            planetCounter = 0;
            showToast('Form cleared');
        }

        // === Data Import/Export ===
        function exportData() {
            if (systemsData.length === 0) {
                showToast('‚ùå No data to export');
                return;
            }

            const dataToExport = {
                _meta: {
                    version: "1.0.0",
                    last_modified: new Date().toISOString(),
                    exported_from: "Haven Mobile Map",
                    system_count: systemsData.length
                },
                data: systemsData
            };

            const json = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `haven_mobile_export_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast('‚úÖ Data exported!');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);

                    // Handle different formats
                    let newSystems = [];
                    if (Array.isArray(imported)) {
                        newSystems = imported;
                    } else if (imported.data && Array.isArray(imported.data)) {
                        newSystems = imported.data;
                    } else if (imported.systems && typeof imported.systems === 'object') {
                        newSystems = Object.values(imported.systems);
                    } else {
                        throw new Error('Unknown data format');
                    }

                    if (confirm(`Import ${newSystems.length} systems? This will add to your existing data.`)) {
                        systemsData = systemsData.concat(newSystems);
                        saveData();
                        renderMap();
                        renderList();
                        updateStats();
                        showToast(`‚úÖ Imported ${newSystems.length} systems!`);
                    }
                } catch (err) {
                    console.error('Import error:', err);
                    showToast('‚ùå Failed to import data. Check file format.');
                }
            };
            reader.readAsText(file);

            // Reset file input
            event.target.value = '';
        }

        function confirmClearData() {
            if (confirm('Delete ALL data? This cannot be undone!\n\nMake sure you exported your data first!')) {
                if (confirm('Are you ABSOLUTELY sure? This will delete everything!')) {
                    systemsData = [];
                    saveData();
                    renderMap();
                    renderList();
                    updateStats();
                    showToast('‚úÖ All data cleared');
                }
            }
        }

        // === Statistics ===
        function updateStats() {
            const totalSystems = systemsData.length;
            let totalPlanets = 0;
            let totalMoons = 0;
            const regions = new Set();

            systemsData.forEach(system => {
                if (system.region) regions.add(system.region);
                if (system.planets) {
                    totalPlanets += system.planets.length;
                    system.planets.forEach(planet => {
                        if (planet.moons) {
                            totalMoons += planet.moons.length;
                        }
                    });
                }
            });

            document.getElementById('stats-info').innerHTML = `
                <strong style="color: var(--accent-cyan);">${totalSystems}</strong> Systems<br>
                <strong style="color: var(--accent-cyan);">${totalPlanets}</strong> Planets<br>
                <strong style="color: var(--accent-cyan);">${totalMoons}</strong> Moons<br>
                <strong style="color: var(--accent-cyan);">${regions.size}</strong> Regions<br>
                <br>
                <em style="color: var(--text-secondary); font-size: 12px;">
                    Data stored locally on your device
                </em>
            `;
        }

        // === Toast Notifications ===
        function showToast(message, duration = 2000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        // Close modal when clicking outside
        document.getElementById('system-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    </script>
</body>
</html>
